@using MyThings.Common.Models
@using Newtonsoft.Json
@model MyThings.Web.ViewModels.HomePageViewModel

@{
    ViewBag.Title = "Index";
    ViewBag.Pageid = "Home";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1 class="homeTitle">MyThings Dashboard</h1>

<div class="gridsterContainer">
    <div class="gridster">
        <ul>
        </ul>
    </div>
</div>


@section scripts{
<script type="text/javascript">

    var gridsterJson = @Html.Raw(@Model.GridsterJson);
    var gridster = null;
    var highestId = 0;
    var x=0;
    var y=0;


    @if(string.IsNullOrEmpty(Model.OriginalGridsterJson))
    {
        @:var originalGridsterJson = [];
    }else{
        @:var originalGridsterJson = @Html.Raw(@Model.OriginalGridsterJson);
    }

    var pinnedSensors = @Html.Raw(JsonConvert.SerializeObject(Model.PinnedSensors));
    var pinnedContainers = @Html.Raw(JsonConvert.SerializeObject(Model.PinnedContainers));
    var pinnedGroups = @Html.Raw(JsonConvert.SerializeObject(Model.PinnedGroups));
    var pinnedErrors = @Html.Raw(JsonConvert.SerializeObject(Model.PinnedErrors));
    var errors = @Html.Raw(JsonConvert.SerializeObject(Model.Errors));

    var errorCount = @ViewBag.ErrorCount.ToString();
    var warningCount = @ViewBag.WarningCount.ToString();

    var fixedTileCount = @ViewBag.FixedTileCount.ToString();
    var customTileCount = @ViewBag.CustomTileCount.ToString();
    var totalTileCount = @ViewBag.TotalTileCount.ToString();

    $(window).load(function () {

        //in pin: savetype en save id, savetype zegt welke tabel, saveid zegt het id van het object daj nodig et
        //Container, Sensor, Error, Group, FixedClock, FixedNavigation, FixedError

        //init grid + behavior
        gridster = $(".gridster ul").gridster({
            widget_base_dimensions: [125, 125],
            max_rows: 5,
            widget_margins: [10, 10],
            helper: 'clone',
            max_size_x: 2,
            max_size_y: 2,
            draggable:{
                stop: function(event, ui){
                    updateLayout(true);
                }
            },
            resize:{
                enabled: true,
                start: function(event, ui, $widget){
                    x = $widget.data('sizex');
                    y = $widget.data('sizey');
                },
                stop: function(event, ui, $widget){
                    gridster.serialize();
                    var units;
                    if((x+y)>2){
                        units = 1;
                        $widget.removeClass("largeWidget");
                        $widget.addClass("smallWidget");
                    } else {
                        units = 2;
                        $widget.removeClass("smallWidget");
                        $widget.addClass("largeWidget");
                    }                  
                    gridster.resize_widget( $widget, units, units);
                    $widget.data('sizex', units);
                    $widget.data('sizey', units);

                    updateLayout(true);
                },
                max_size: [2, 2],
                min_size: [1, 1]
            },
            shift_widgets_up: false,
            shift_larger_widgets_down: false,
            collision: {
                wait_for_mouseup: true
            }
        }).data('gridster');

        //insert all current and new tiles and update the layout to the database
        var newTileCount = 0;
        $.each(gridsterJson, function (index, value) {
            if (value.Id === 0) {
                newTileCount ++;
                gridster.add_widget('<li class="smallWidget tile"></li>');
            } else {
                if (value.Size_X === 0) value.Size_X = 1;
                if (value.Size_Y === 0) value.Size_Y = 1;
                if(value.Size_X === 1) gridster.add_widget('<li class="smallWidget tile"></li>', value.Size_X, value.Size_Y, value.Col, value.Row);
                else gridster.add_widget('<li class="largeWidget tile"></li>', value.Size_X, value.Size_Y, value.Col, value.Row);
            }

            if(highestId < gridsterJson[index].Id) highestId = gridsterJson[index].Id;
        });
        if (newTileCount > 0) updateLayout(true);
        else updateLayout(false);

        //fill tiles with right contents based on gridsterJson
        $.each(gridsterJson, function (index, value) {
            //console.log(value);
            var tile = $(".gridster ul").find("[data-row='" + value.row + "'][data-col='" + value.col + "']");
            refreshTile(tile, value);
        });
    });

    function refreshTile(tile, tileInfo){          
        var url;
        switch(tileInfo.Pin.SavedTypeString){
            //Container, Sensor, Error, Group, FixedClock, FixedNavigation, FixedError            
            case "Sensor":
                url = "";
                break;
            case "Container":
                url = "get/getmostrecentvalue?containerId=";                      
                break;
            case "Error":
                url = "";
                break;
            case "Group":
                url = "";
                break;                     
            case "FixedError":
                url =  "";
                break;
            default: case "FixedClock": case "FixedNavigation":
                url = "";
        }

        if (url === "") setTileValue(tile, tileInfo, null, null);
        else {
            $.ajax({
                url: apiBaseUrl + url + tileInfo.Pin.SavedId,
                method: "GET"
            }).done(function (json) {
                if (json != null) {
                    var data = JSON.parse(json);
                    var value;
                    if (data.CurrentValue.HexValue) value = data.CurrentValue.HexValue;
                    else value = data.CurrentValue.Value
                    setTileValue(tile, tileInfo, value, new Date(Date.parse(data.CurrentValue.Timestamp)));
                }
            }).fail(function (json) {
                if ($.isFunction(MyThings.logToUser)) {
                    MyThings.logToUser("Item" + tileInfo.Pin.SavedTypeString + " " +
                        tileInfo.Pin.Id +
                        " could not be loaded.");
                    setTileValue(tile, tileInfo, null, null);
                }
            });
        }
    }

    function setTileValue(tile, tileInfo, value, time) {
        
        var innerHtml = "";
        console.log(tileInfo.Pin.SavedTypeString);
            
            switch(tileInfo.Pin.SavedTypeString){
                //Container, Sensor, Error, Group, FixedClock, FixedNavigation, FixedError
                case "Sensor":
                    innerHtml += "Sensor";
                    break;
                case "Container":
                    var werkContainer = $.grep(pinnedContainers, function(e){  return e.Id === tileInfo.Pin.SavedId; })[0];

                    innerHtml +=
                        "<p title='" +
                        werkContainer.Name +
                        "' class='itemName'>" +
                        werkContainer.Name +
                        "</p>" +
                        "<p class='itemType'>" +
                        werkContainer.ContainerType.Name +
                        "</p>" +
                        "<p class='itemValue'>" +
                        (Math.round(parseFloat(value) * 10) / 10);

                    // var containerValue = ;
                    //if(werkContainer.ContainerType.Name !== "Temperature") innerHtml += "TBT";

                    switch(werkContainer.ContainerType.Name){
                        case "Battery level":
                            innerHtml += "<sup>%</sup></p>" +
                                "<img class='pinimg customimg' alt='Battery' src='http://loradatagroep9.blob.core.windows.net/proximusimages/battery-icon-white.png' />";
                            break;
                        case "Temperature":
                            innerHtml += "<sup>°C</sup></p>" +
                                "<img class='pinimg customimg' alt='Temperature' src='http://loradatagroep9.blob.core.windows.net/proximusimages/temperature-icon-white.png' />";
                            break;
                        case "Humidity":
                            innerHtml += "<sup>%</sup></p>" +
                            "<img class='pinimg customimg' alt='Humidity' src='http://loradatagroep9.blob.core.windows.net/proximusimages/humidity-icon-white.png' />";
                            break;
                        case "GPS":                           
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='Location' src='http://loradatagroep9.blob.core.windows.net/proximusimages/location-icon-white.png' />";
                            break;
                        case "OnOff": case "Button1":

                            break;
                        case "Luminance":
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='Luminance' src='http://loradatagroep9.blob.core.windows.net/proximusimages/luminance-icon-white.png' />";
                            break;
                        case "PIR":
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='PIR' src='http://loradatagroep9.blob.core.windows.net/proximusimages/eye-icon-white.png' />";
                            break;
                        case "Accelerometer":
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='Accelerometer' src='http://loradatagroep9.blob.core.windows.net/proximusimages/accelerometer-icon-white.png' />";
                            break;
                        case "Simple Metering Current": case "Simple Metering Demand":
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='Simple Metering' src='http://loradatagroep9.blob.core.windows.net/proximusimages/power-icon-white.png' />";
                            break;
                        default: case "Raw payload":
                            innerHtml += "</p>" +
                            "<img class='pinimg customimg' alt='Generic' src='http://loradatagroep9.blob.core.windows.net/proximusimages/proximus-x-white.png' />";
                            break;
                    }
                                                            
                    break;
                case "Error":
                    innerHtml += "Error";
                    break;
                case "Group":
                    innerHtml += "Group";
                    break;
                case "FixedClock":
                    innerHtml += "FixedClock";
                    break;
                case "FixedNavigation":
                    innerHtml += "FixedNavigation";
                    break;
                case "FixedError":
                    innerHtml += "ErrFixedErroror";
                    break;
                default:
                    innerHtml += "Other";
                    break;
            }
        if(time) innerHtml += '<p class="itemValueTimeStampTime">' + time.toLocaleTimeString() + '</p><p class="itemValueTimeStampDate">' + time.toLocaleDateString() + '</p>';
        innerHtml += '<span class="gs-resize-handle gs-resize-handle-both"></span>';
        tile.html(innerHtml);
    }


    function updateLayout(toDatabase){
        var newPos = gridster.serialize();
        $.each(newPos, function (index, value) {
            newPos[index].Pin = gridsterJson[index].Pin;
            if(newPos[index].Pin.TileId === 0){
                highestId++;
                newPos[index].Pin.TileId = highestId;
            }
            newPos[index].Id = newPos[index].Pin.TileId;
        });
        gridsterJson = newPos;

        if(toDatabase)
        {
            $.ajax({
                method: 'POST',
                contentType: 'application/json; charset=utf-8',
                url: siteBaseUrl + "UpdateGridString",
                data: JSON.stringify({ gridsterJson: gridsterJson })
            }).done(function(){
                console.log("Layout saved.")
            }).fail(function(json) {
                if ($.isFunction(MyThings.logToUser)) {
                    MyThings.logToUser("Layout could not be saved.");
                }
            });
        }
    }
</script>
}



        @*
                //Clock Javascript
        (function() {
            initLocalClocks();
            moveSecondHands();
            setUpMinuteHands();


            //nieuw
            MaakEenGrid();

        })();

        function MaakEenGrid(){
            $(".gridster ul").gridster({
                widget_margins: [5, 5],
                widget_base_dimensions: [140, 140]
            });
        }

        //GRIDSTER DEMO JAVASCRIPT //TODO: Remodel this javascript
        var originalGridsterJson = "@Model.OriginalGridsterJson";
        var gridsterJson = @Html.Raw(@Model.GridsterJson);

        var pinnedSensors = [];
        var pinnedContainers = [];
        var pinnedGroups = [];
        var pinnedErrors = [];
        var errors = [];

        var errorCount = @ViewBag.ErrorCount.ToString();
        var warningCount = @ViewBag.WarningCount.ToString();

        var fixedTileCount = @ViewBag.FixedTileCount.ToString();
        var customTileCount = @ViewBag.CustomTileCount.ToString();
        var totalTileCount = @ViewBag.TotalTileCount.ToString();

        @foreach (Sensor sensor in Model.PinnedSensors)
        {
            @: var sensor = Sensor.loadFromJson("@JsonConvert.SerializeObject(sensor)");
            @: pinnedSensors.push(sensor);
        }

        @foreach (Container container in Model.PinnedContainers)
        {
            @: var container = new Container("@container.Id.ToString()", "@container.Name",  "@container.MACAddress",  "@container.CreationTime.ToShortDateString()", "@container.LastUpdatedTime.ToShortDateString()",
            @: "@container.ContainerType.ToString()", "@container.SensorId.ToString()", "@container.CurrentValue", "@container.History");
            @: pinnedContainers.push(container);
        }

        @foreach (Group group in Model.PinnedGroups)
        {
            @: var group = new Group("@group.Id", "@group.Name", "@group.Sensors");
            @: pinnedGroups.push(group);
        }

        @foreach (Error error in Model.PinnedErrors)
        {
            @: var error = new Error("@error.Id", "@error.ErrorCode", "@error.Type", "@error.Category", "@error.Title", "@error.Description", "@error.Advice",
            @: "@error.Time", "@error.Read", "@error.Sensor", "@error.Container");
            @: pinnedErrors.push(error);
        }

        @foreach (Error error in Model.Errors)
        {
            @: var error = new Error("@error.Id", "@error.ErrorCode", "@error.Type", "@error.Category", "@error.Title", "@error.Description", "@error.Advice",
            @: "@error.Time", "@error.Read", "@error.Sensor", "@error.Container");
            @: errors.push(error);
        }

        console.log(gridsterJson);

        console.log(pinnedSensors);
        console.log(pinnedContainers);
        console.log(pinnedGroups);
        console.log(pinnedErrors);

        console.log(errors);

        console.log(totalTileCount);
    </script>
        *@


        @*BRUNO*@


        @*<div class="mainhomepagediv">
        <div class="clockdiv maindiv">
            <div class="largesquaretile unhoverabletile">
                <div class="clock customimg">
                    <div class="hours-container">
                        <div class="hours"></div>
                    </div>
                    <div class="minutes-container">
                        <div class="minutes"></div>
                    </div>
                    <div class="seconds-container">
                        <div class="seconds"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="warningdiv maindiv">
            <a href="@Url.Action("Warning", "Dashboard")">
                <div class="largesquaretile">
                    <div class="textdiv"> Warnings</div>
                    <div class="warningvalue ciphervalue">2</div>
                    <img class="warningimg customimg" alt="warningicon" src="http://loradatagroep9.blob.core.windows.net/proximusimages/error-icon.png" />
                </div>
            </a>
        </div>
        <div class="errordiv maindiv">
            <a href="@Url.Action("Error", "Dashboard")">
                <div class="largesquaretile">
                    <div class="textdiv">Errors</div>
                    <div class="errorvalue ciphervalue">5</div>
                    <img class="errorimg customimg" alt="erroricon" src="http://loradatagroep9.blob.core.windows.net/proximusimages/warning-icon.png" />
                </div>
            </a>
        </div>
        logout
        <div class="logoutdiv maindiv">
            <a href="@Url.Action("About", "Dashboard")">
                <div class="largesquaretile">
                    <img class="logoutimg customimg" alt="logouticon" src="http://loradatagroep9.blob.core.windows.net/proximusimages/door-icon.png" />
                </div>
            </a>
        </div>
        <div class="Sensormngmtdiv maindiv">
            <a href="@Url.Action("Sensors", "Dashboard")">
                <div class="smallsquaretile">
                    <div class="textdivsmallsquare">Sensor management</div>
                </div>
            </a>
        </div>
        <div class="containerdiv maindiv">
            <a href="@Url.Action("Containers", "Dashboard")">
                <div class="smallsquaretile">
                    <div class="textdivsmallsquare">Containers</div>
                </div>
            </a>
        </div>
        <div class="Invoicediv maindiv">
            <a href="@Url.Action("Invoice", "Dashboard")">
                <div class="horizontalrectangletile">
                    <div class="textdivsmallsquare">Invoice</div>
                </div>
            </a>
        </div>
        <div class="Supportdiv maindiv">
            <a href="@Url.Action("Support", "Dashboard")">
                <div class="smallsquaretile">
                    <div class="textdivsmallsquare">Support</div>
                </div>
            </a>
        </div>
        <div class="Mapdiv maindiv">
            <a href="@Url.Action("Map", "Dashboard")">
                <div class="smallsquaretile">
                    <div class="textdivsmallsquare">Geographic overview sensors</div>
                </div>
            </a>
        </div>

        @* <div class="Pinneddiv maindiv">
                <a href="@Url.Action("Map", "Dashboard")">
                    <div class="verticalrectangletile">
                        <img class="pinimg customimg" alt="logouticon" src="http://loradatagroep9.blob.core.windows.net/proximusimages/Pin-icon.png" />
                        <div class="textdivrectangle">Groupname</div>
                    </div>
                </a>
            </div>
    </div>*@


